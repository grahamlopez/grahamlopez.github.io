
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gentoo &#8212; graham lopez  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Ubuntu 20.04" href="ubuntu_20.04.html" />
    <link rel="prev" title="Operating Systems" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">graham lopez</a></h1>



<p class="blurb">Notes by/for, and a little bit about M. Graham Lopez</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact me</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv.html">Curriculum Vitae</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/index.html">git hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../privacy_security/index.html">Privacy / Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blog/index.html">blog(ish)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contained/index.html">Containers / VPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli_tools/index.html">CLI Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Operating Systems</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Gentoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="ubuntu_20.04.html">Ubuntu 20.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="windows10.html">Windows 10</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#partitioning">Partitioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../unsorted/index.html">unsorted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sphinx/index.html">sphinx</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Operating Systems</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Operating Systems</a></li>
      <li>Next: <a href="ubuntu_20.04.html" title="next chapter">Ubuntu 20.04</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="index.html" title="Previous document">Operating Systems</a>
        </li>
        <li>
          <a href="ubuntu_20.04.html" title="Next document">Ubuntu 20.04</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <div class="section" id="gentoo">
<h1>Gentoo<a class="headerlink" href="#gentoo" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#installation-quicknotes" id="id3">Installation Quicknotes</a><ul>
<li><a class="reference internal" href="#get-to-the-chroot" id="id4">Get to the chroot</a></li>
<li><a class="reference internal" href="#configure-build-the-system" id="id5">Configure/build the system</a></li>
<li><a class="reference internal" href="#configure-build-the-kernel" id="id6">configure/build the kernel</a></li>
<li><a class="reference internal" href="#filesystem-information" id="id7">filesystem information</a></li>
<li><a class="reference internal" href="#networking" id="id8">networking</a></li>
<li><a class="reference internal" href="#install-utilities" id="id9">install utilities</a></li>
<li><a class="reference internal" href="#bootloader-non-efi-booting" id="id10">bootloader (non-EFI booting)</a></li>
<li><a class="reference internal" href="#final-configuration" id="id11">final configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#early-configuration" id="id12">Early configuration</a></li>
<li><a class="reference internal" href="#more-installation-security" id="id13">More installation security</a></li>
<li><a class="reference internal" href="#dual-booting-e-g-ubuntu" id="id14">Dual Booting (e.g. Ubuntu)</a><ul>
<li><a class="reference internal" href="#ubuntu-20-04-after-gentoo" id="id15">Ubuntu 20.04 after Gentoo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#encrypted-drive" id="id16">Encrypted drive</a></li>
<li><a class="reference internal" href="#rescue-partitions-and-media" id="id17">Rescue partitions and media</a><ul>
<li><a class="reference internal" href="#manual-backups" id="id18">manual backups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#uefi-boot-no-bootloader" id="id19">UEFI boot (no bootloader)</a></li>
<li><a class="reference internal" href="#systemd-gnome-3-28" id="id20">Systemd / Gnome 3.28+</a></li>
<li><a class="reference internal" href="#notes-on-using-portage" id="id21">Notes on Using Portage</a><ul>
<li><a class="reference internal" href="#saving-space" id="id22">saving space</a></li>
<li><a class="reference internal" href="#make-conf" id="id23">make.conf</a></li>
<li><a class="reference internal" href="#use-flags" id="id24">USE flags</a></li>
<li><a class="reference internal" href="#video-cards" id="id25">VIDEO_CARDS</a></li>
<li><a class="reference internal" href="#tips-and-tricks" id="id26">tips and tricks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unsorted" id="id27">Unsorted</a><ul>
<li><a class="reference internal" href="#tmux-split-characters" id="id28">tmux split characters</a></li>
<li><a class="reference internal" href="#lcd-brightness" id="id29">lcd brightness</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-gentoo" id="id30">Other Gentoo</a></li>
</ul>
</div>
<div class="section" id="installation-quicknotes">
<h2><a class="toc-backref" href="#id3">Installation Quicknotes</a><a class="headerlink" href="#installation-quicknotes" title="Permalink to this headline">¶</a></h2>
<p>Installation resources</p>
<ul class="simple">
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64" target="_blank">gentoo AMD64 handbook (sectioned)</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation" target="_blank">gentoo AMD64 handbook (installation - Full page)</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Systemd" target="_blank">systemd installation</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Full_Disk_Encryption_From_Scratch_Simplified" target="_blank">gentoo wiki - Full Disk Encryption From Scratch Simplified</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide" target="_blank">Sakaki’s EFI Install Guide</a></li>
</ul>
<div class="section" id="get-to-the-chroot">
<h3><a class="toc-backref" href="#id4">Get to the chroot</a><a class="headerlink" href="#get-to-the-chroot" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Networking" target="_blank">Enable networking</a>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">ifconfig</span> <span class="pre">-a</span></code></li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">net-setup</span> <span class="pre">wlp3s0</span></code></dt><dd>(details for <a class="reference external" href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Setting_Up_Networking_and_Connecting_via_ssh" target="_blank">manual wifi setup at Sakaki’s guide</a>)</dd>
</dl>
</li>
<li><code class="docutils literal notranslate"><span class="pre">ping</span> <span class="pre">google.com</span></code></li>
</ul>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks" target="_blank">Preparing the disks</a>:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">lsblk</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">parted</span> <span class="pre">-a</span> <span class="pre">optimal</span> <span class="pre">/dev/sda</span></code></p>
</li>
<li><p class="first">using parted (from <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Default:_Using_parted_to_partition_the_disk" target="_blank">handbook</a>
or <a class="reference external" href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key" target="_blank">Sakaki’s guide with LVM, LUKS, EFI boot</a>)</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">print</span></code> or just <code class="docutils literal notranslate"><span class="pre">p</span></code> to print the current partition table</p>
</li>
<li><p class="first">make a new partition table (destroys entire disk):</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">mklabel</span> <span class="pre">gpt</span></code></p>
</div></blockquote>
</li>
<li><p class="first">set units to work in with e.g. <code class="docutils literal notranslate"><span class="pre">unit</span> <span class="pre">mib</span></code>, <code class="docutils literal notranslate"><span class="pre">unit</span> <span class="pre">gib</span></code>, or <code class="docutils literal notranslate"><span class="pre">unit</span> <span class="pre">s</span></code>
for sectors. Also need an <code class="docutils literal notranslate"><span class="pre">s</span></code> suffix on numbers for working with
sectors.</p>
</li>
<li><dl class="first docutils">
<dt>make partitions</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">mkpart</span> <span class="pre">primary</span> <span class="pre">START</span> <span class="pre">END</span></code> (in whatever units)</li>
<li><code class="docutils literal notranslate"><span class="pre">mkpart</span> <span class="pre">primary</span> <span class="pre">fat32</span> <span class="pre">1</span> <span class="pre">1024</span></code> (for an EFI boot partition)</li>
<li><code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">1</span> <span class="pre">efiboot</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">1</span> <span class="pre">boot</span> <span class="pre">on</span></code> (<a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Default_partitioning_scheme" target="_blank">see here</a>
and <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Creating_the_EFI_system_partition_.28ESP.29" target="_blank">here</a>)</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">if the installation media isn’t booted with EFI, then
‘/sys/firmware/efi` will not be properly populated and confuse the grup
installation later on.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">“For completeness, the BIOS boot partition is needed when a GPT
partition layout is used with GRUB2 in PC/BIOS mode. It is not required when
booting in EFI/UEFI mode.”</p>
</div>
</div></blockquote>
</li>
<li><dl class="first docutils">
<dt>make the filesystems and mount:</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">mkfs.fat</span> <span class="pre">-F</span> <span class="pre">32</span> <span class="pre">/dev/sda1</span></code> (see <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation#Using_UEFI" target="_blank">here in the handbook</a> about using EFI.)</li>
<li><code class="docutils literal notranslate"><span class="pre">mkfs.ext4</span> <span class="pre">/dev/sda3</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">/dev/sda3</span> <span class="pre">/mnt/gentoo</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">/mnt/gentoo/boot</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">/dev/sda1</span> <span class="pre">/mnt/gentoo/boot</span></code></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>install stage3</p>
<ul>
<li><p class="first">ensure that the system <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Stage#Setting_the_date_and_time" target="_blank">time is correct</a>.
It is okay if it is still in UTC - we’ll fix the timezone later.</p>
</li>
<li><dl class="first docutils">
<dt>download the tarball:</dt><dd><ul>
<li><p class="first"><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Stage#Downloading_the_stage_tarball" target="_blank">browse to it with links</a>:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">links</span> <span class="pre">https://www.gentoo.org/downloads/mirrors</span></code></p>
<p>releases –&gt; amd4 –&gt; autobuilds</p>
</div></blockquote>
</li>
<li><dl class="first docutils">
<dt><a class="reference external" href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Installing_the_Gentoo_Stage_3_Files#Downloading.2C_Verifying_and_Unpacking_the_Gentoo_Stage_3_Tarball" target="_blank">or get it directly</a>:</dt><dd><ul class="simple">
<li>get the release file name from <a class="reference external" href="http://distfiles.gentoo.org/releases/amd64/autobuilds/latest-stage3-amd64.txt" target="_blank">http://distfiles.gentoo.org/releases/amd64/autobuilds/latest-stage3-amd64.txt</a></li>
<li><code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">-c</span> <span class="pre">http://distfiles.gentoo.org/releases/amd64/autobuilds/YYYYMMDDThhmmssZ/stage3-amd64-YYYYMMDDThhmmssZ.tar.xz</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>and the verification signatures</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">-c</span> <span class="pre">http://distfiles.gentoo.org/releases/amd64/autobuilds/YYYYMMDDThhmmssZ/stage3-amd64-YYYYMMDDThhmmssZ.tar.xz.CONTENTS</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">-c</span> <span class="pre">http://distfiles.gentoo.org/releases/amd64/autobuilds/YYYYMMDDThhmmssZ/stage3-amd64-YYYYMMDDThhmmssZ.tar.xz.DIGESTS.asc</span></code></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">move the tarball to <code class="docutils literal notranslate"><span class="pre">/mnt/gentoo</span></code></p>
</li>
<li><p class="first">unpack the tarball:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">tar</span> <span class="pre">xvpf</span> <span class="pre">stage3-*.tar.xz</span> <span class="pre">--xattrs-include='*.*'</span> <span class="pre">--numeric-owner</span></code></p>
</div></blockquote>
</li>
</ul>
<p>enter the chroot</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><a class="reference external" href="https://wiki.gentoo.org/wiki/Mirrorselect" target="_blank">preconfigure mirrors</a> for the new system</dt><dd><ul>
<li><code class="docutils literal notranslate"><span class="pre">mirrorselect</span> <span class="pre">-i</span> <span class="pre">-o</span> <span class="pre">&gt;&gt;</span> <span class="pre">/mnt/gentoo/etc/portage/make.conf</span></code> (interactive selection)</li>
<li><code class="docutils literal notranslate"><span class="pre">mirrorselect</span> <span class="pre">-c</span> <span class="pre">USA</span> <span class="pre">-s3</span> <span class="pre">-b10</span> <span class="pre">-D</span> <span class="pre">&amp;&amp;</span> <span class="pre">cp</span> <span class="pre">/etc/portage/make.conf</span> <span class="pre">/mnt/gentoo/etc/portage</span></code> (choose the 3 fastest USA mirrors)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>mount the filesystems</dt><dd><ul>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-t</span> <span class="pre">proc</span> <span class="pre">/proc</span> <span class="pre">/mnt/gentoo/proc</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-R</span> <span class="pre">/sys</span> <span class="pre">/mnt/gentoo/sys</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-R</span> <span class="pre">/dev</span> <span class="pre">/mnt/gentoo/dev</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">--make-rslave</span> <span class="pre">/mnt/gentoo/sys</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">--make-rslave</span> <span class="pre">/mnt/gentoo/dev</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-L</span> <span class="pre">/etc/resolv.conf</span> <span class="pre">/mnt/gentoo/etc</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">chroot</span> <span class="pre">/mnt/gentoo</span> <span class="pre">/bin/bash</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">/etc/profile</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">PS1=&quot;(chroot)</span> <span class="pre">${PS1}&quot;</span></code></li>
</ul>
</div>
<div class="section" id="configure-build-the-system">
<h3><a class="toc-backref" href="#id5">Configure/build the system</a><a class="headerlink" href="#configure-build-the-system" title="Permalink to this headline">¶</a></h3>
<p>configure the build options:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">/etc/portage/repos.conf</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">/usr/share/portage/config/repos.conf</span> <span class="pre">/etc/portage/repos.conf/gentoo.conf</span></code>
to <a class="reference external" href="https://wiki.gentoo.org/wiki//etc/portage/repos.conf" target="_blank">set up the repositories</a>.
(and see here for more about the <a class="reference external" href="https://wiki.gentoo.org/wiki/Project:Portage/Sync" target="_blank">sync system</a>)</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">nano</span> <span class="pre">/etc/portage/make.conf</span></code></dt><dd><ul>
<li><code class="docutils literal notranslate"><span class="pre">COMMON_FLAGS=&quot;-march=native</span> <span class="pre">-02</span> <span class="pre">-pipe</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">MAKEOPTS=&quot;-j2&quot;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PORTAGE_TMPDIR=&quot;/dev/shm&quot;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PORTAGE_TMPFS=&quot;/dev/shm&quot;</span></code></li>
</ul>
</dd>
</dl>
</li>
<li>might also have to add <code class="docutils literal notranslate"><span class="pre">none</span>&#160;&#160; <span class="pre">/dev/shm</span>&#160;&#160;&#160; <span class="pre">tmpfs</span>&#160;&#160; <span class="pre">rw,nosuid,nodev,relatime</span> <span class="pre">0</span> <span class="pre">0</span></code>
to <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> to remove the <code class="docutils literal notranslate"><span class="pre">noexec</span></code> option to allow portage to work
in the tmpfs.</li>
</ul>
<p>install a snapshot and update:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">emerge-webrsync</span></code> to get the latest snapshot of the portage tree</li>
<li><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">--sync</span></code> to bring the portage tree up to date</li>
</ul>
<p>configure the build options for the system</p>
<div class="admonition error">
<p class="first admonition-title">Error</p>
<p>FIXME</p>
<ul class="last simple">
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation#Optional:_Configuring_the_ACCEPT_LICENSE_variable" target="_blank">set the ACCEPT_LICENSE options</a></li>
<li>set package options in /etc/portage/package.use/</li>
</ul>
</div>
<p>build the system</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">eslect</span> <span class="pre">profile</span> <span class="pre">list/set</span></code></p>
<blockquote>
<div><p>“A profile is a building block for any Gentoo system. Not only does it
specify default values for USE, CFLAGS, and other important variables, it
also locks the system to a certain range of package versions. These settings
are all maintained by Gentoo’s Portage developers.”</p>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Profile_(Portage)" target="_blank">gentoo wiki on profiles</a></p>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">--ask</span> <span class="pre">--verbose--update</span> <span class="pre">--deep</span> <span class="pre">--newuse</span> <span class="pre">&#64;world</span></code></p>
</li>
<li><p class="first">here, we can go ahead and install vim, tmux, zsh, git</p>
</li>
</ul>
<p>initial system configuration</p>
<ul>
<li><p class="first">set the timezone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;America/New_York&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">timezone</span>
<span class="n">emerge</span> <span class="o">--</span><span class="n">config</span> <span class="n">sys</span><span class="o">-</span><span class="n">libs</span><span class="o">/</span><span class="n">timezone</span><span class="o">-</span><span class="n">data</span>
</pre></div>
</div>
</li>
<li><p class="first">configure locale (<a class="reference external" href="https://wiki.gentoo.org/wiki/Localization/Guide" target="_blank">localization guide</a> and the <a class="reference external" href="https://wiki.gentoo.org/wiki/UTF-8" target="_blank">utf8 article</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">locale</span><span class="o">.</span><span class="n">gen</span>

<span class="n">en_US</span> <span class="n">ISO</span><span class="o">-</span><span class="mi">8859</span><span class="o">-</span><span class="mi">1</span>
<span class="n">en_US</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="n">locale</span><span class="o">-</span><span class="n">gen</span>
<span class="n">eselect</span> <span class="n">locale</span> <span class="nb">list</span><span class="o">/</span><span class="nb">set</span>
<span class="n">env</span><span class="o">-</span><span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">source</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">profile</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="configure-build-the-kernel">
<h3><a class="toc-backref" href="#id6">configure/build the kernel</a><a class="headerlink" href="#configure-build-the-kernel" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">--ask</span> <span class="pre">sys-kernel/gentoo-sources</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/usr/src/linux</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">localyesconfig</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">&amp;&amp;</span> <span class="pre">make</span> <span class="pre">modules_install</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">/boot/vmlinux-&lt;version&gt;-gentoo</span> <span class="pre">/boot/EFI/BOOT/BOOTX64.EFI</span></code> (if using EFI boot)</li>
</ul>
<p>If we’re booting straight from EFI, make sure that the following are
configured:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processor</span> <span class="nb">type</span> <span class="ow">and</span> <span class="n">features</span>  <span class="o">---&gt;</span>
  <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">EFI</span> <span class="n">runtime</span> <span class="n">service</span> <span class="n">support</span>
  <span class="p">[</span><span class="o">*</span><span class="p">]</span>   <span class="n">EFI</span> <span class="n">stub</span> <span class="n">support</span>
  <span class="p">[</span> <span class="p">]</span>     <span class="n">EFI</span> <span class="n">mixed</span><span class="o">-</span><span class="n">mode</span> <span class="n">support</span>
  <span class="o">...</span>
  <span class="o">...</span>
  <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Built</span><span class="o">-</span><span class="ow">in</span> <span class="n">kernel</span> <span class="n">command</span> <span class="n">line</span>
  <span class="p">(</span><span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span><span class="p">)</span>
</pre></div>
</div>
<p>And maybe using <code class="docutils literal notranslate"><span class="pre">root=PARTUUID=</span></code> is preferable. Then use <code class="docutils literal notranslate"><span class="pre">blkid</span></code> and do
something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processor</span> <span class="nb">type</span> <span class="ow">and</span> <span class="n">features</span>  <span class="o">---&gt;</span>
  <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Built</span><span class="o">-</span><span class="ow">in</span> <span class="n">kernel</span> <span class="n">command</span> <span class="n">line</span>
  <span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">PARTUUID</span><span class="o">=</span><span class="n">adf55784</span><span class="o">-</span><span class="mi">15</span><span class="n">d9</span><span class="o">-</span><span class="mi">4</span><span class="n">ca3</span><span class="o">-</span><span class="n">bb3f</span><span class="o">-</span><span class="mi">56</span><span class="n">de0b35d88d</span><span class="p">)</span>
</pre></div>
</div>
<p>To ensure that wireless firmware can be loaded (firmware will be installed later
on), make sure that the drivers are built as modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Device</span> <span class="n">Drivers</span>  <span class="o">---&gt;</span>

        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Network</span> <span class="n">device</span> <span class="n">support</span>  <span class="o">---&gt;</span>

        <span class="o">---</span> <span class="n">Network</span> <span class="n">device</span> <span class="n">support</span>
        <span class="p">[</span><span class="o">*</span><span class="p">]</span>   <span class="n">Wireless</span> <span class="n">LAN</span>  <span class="o">---&gt;</span>

            <span class="o">---</span> <span class="n">Wireless</span> <span class="n">LAN</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">mac80211</span><span class="o">-</span><span class="n">based</span> <span class="n">legacy</span> <span class="n">WDS</span> <span class="n">support</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">ADMtek</span> <span class="n">devices</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">Atheros</span><span class="o">/</span><span class="n">Qualcomm</span> <span class="n">devices</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">Atmel</span> <span class="n">devices</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">Broadcom</span> <span class="n">devices</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">Cisco</span> <span class="n">devices</span>
            <span class="p">[</span><span class="o">*</span><span class="p">]</span>   <span class="n">Intel</span> <span class="n">devices</span>
            <span class="o">&lt;</span> <span class="o">&gt;</span>     <span class="n">Intel</span> <span class="n">PRO</span><span class="o">/</span><span class="n">Wireless</span> <span class="mi">2100</span> <span class="n">Network</span> <span class="n">Connection</span>
            <span class="o">&lt;</span> <span class="o">&gt;</span>     <span class="n">Intel</span> <span class="n">PRO</span><span class="o">/</span><span class="n">Wireless</span> <span class="mi">2200</span><span class="n">BG</span> <span class="ow">and</span> <span class="mi">2915</span><span class="n">ABG</span> <span class="n">Network</span> <span class="n">Connection</span>
            <span class="o">&lt;</span> <span class="o">&gt;</span>     <span class="n">Intel</span> <span class="n">Wireless</span> <span class="n">WiFi</span> <span class="mi">4965</span><span class="n">AGN</span> <span class="p">(</span><span class="n">iwl4965</span><span class="p">)</span>
            <span class="o">&lt;</span> <span class="o">&gt;</span>     <span class="n">Intel</span> <span class="n">PRO</span><span class="o">/</span><span class="n">Wireless</span> <span class="mi">3945</span><span class="n">ABG</span><span class="o">/</span><span class="n">BG</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">iwl3945</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span>     <span class="n">Intel</span> <span class="n">Wireless</span> <span class="n">WiFi</span> <span class="n">Next</span> <span class="n">Gen</span> <span class="n">AGN</span> <span class="o">-</span> <span class="n">Wireless</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="n">Advanced</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="n">Ultimate</span><span class="o">-</span><span class="n">N</span> <span class="p">(</span><span class="n">iwlwifi</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span>       <span class="n">Intel</span> <span class="n">Wireless</span> <span class="n">WiFi</span> <span class="n">DVM</span> <span class="n">Firmware</span> <span class="n">support</span>
            <span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span>       <span class="n">Intel</span> <span class="n">Wireless</span> <span class="n">WiFi</span> <span class="n">MVM</span> <span class="n">Firmware</span> <span class="n">support</span>
                      <span class="n">Debugging</span> <span class="n">Options</span>  <span class="o">---&gt;</span>
            <span class="p">[</span> <span class="p">]</span>   <span class="n">Intersil</span> <span class="n">devices</span>
</pre></div>
</div>
</div>
<div class="section" id="filesystem-information">
<h3><a class="toc-backref" href="#id7">filesystem information</a><a class="headerlink" href="#filesystem-information" title="Permalink to this headline">¶</a></h3>
<p>Edit <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> with either device names or UUIDs as given by the <code class="docutils literal notranslate"><span class="pre">blkid</span></code>
command. Note that the <code class="docutils literal notranslate"><span class="pre">/boot</span></code> partition doesn’t necessarily have to be
present/mounted.</p>
</div>
<div class="section" id="networking">
<h3><a class="toc-backref" href="#id8">networking</a><a class="headerlink" href="#networking" title="Permalink to this headline">¶</a></h3>
<p>Edit <code class="docutils literal notranslate"><span class="pre">/etc/conf.d/hostname</span></code> to set the hostname.</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">-a</span> <span class="pre">--noreplace</span> <span class="pre">net-misc/netifrc</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">-a</span> <span class="pre">dhcpcd</span> <span class="pre">wpa_supplicant</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">vim</span> <span class="pre">/etc/conf.d/net</span></code> gets <code class="docutils literal notranslate"><span class="pre">config_wlp2s0=&quot;dhcp&quot;</span></code></p>
</li>
<li><p class="first">add hostname to <code class="docutils literal notranslate"><span class="pre">/etc/hosts`</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">vim</span> <span class="pre">/etc/wpa_supplicant/wpa_supplicant.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># The below line not be changed otherwise wpa_supplicant refuses to work</span>
<span class="n">ctrl_interface</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">wpa_supplicant</span>

<span class="c1"># Ensure that only root can read the WPA configuration</span>
<span class="n">ctrl_interface_group</span><span class="o">=</span><span class="mi">0</span>

<span class="c1"># Let wpa_supplicant take care of scanning and AP selection</span>
<span class="n">ap_scan</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># Simple case: WPA-PSK, PSK as an ASCII passphrase, allow all valid ciphers</span>
<span class="n">network</span><span class="o">=</span><span class="p">{</span>
  <span class="n">ssid</span><span class="o">=</span><span class="s2">&quot;simple&quot;</span>
  <span class="n">psk</span><span class="o">=</span><span class="s2">&quot;very secret passphrase&quot;</span>
  <span class="c1"># The higher the priority the sooner we are matched</span>
  <span class="n">priority</span><span class="o">=</span><span class="mi">5</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">rc-update</span> <span class="pre">add</span> <span class="pre">wpa_supplicant</span> <span class="pre">default</span></code></p>
</li>
</ul>
<p>see here for information on <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:X86/Networking/Wireless" target="_blank">wireless networking in gentoo</a>.</p>
<p>probably also need <a class="reference external" href="https://wiki.gentoo.org/wiki/Iwlwifi" target="_blank">firmware for iwlwifi</a>.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">linux-firmware</span></code></li>
<li>and make the kernel options modules (see the kernel config section above).</li>
</ul>
</div>
<div class="section" id="install-utilities">
<h3><a class="toc-backref" href="#id9">install utilities</a><a class="headerlink" href="#install-utilities" title="Permalink to this headline">¶</a></h3>
<p>miscellaneous configuration</p>
<ul class="simple">
<li>set the root password</li>
<li>check <code class="docutils literal notranslate"><span class="pre">/etc/rc.conf</span></code></li>
<li>check <code class="docutils literal notranslate"><span class="pre">/etc/conf.d/hwclock</span></code></li>
</ul>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation#System_logger" target="_blank">install utilities</a></p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">syslog-ng</span> <span class="pre">logrotate</span> <span class="pre">cronie</span> <span class="pre">mlocate</span> <span class="pre">e2fsprogs</span> <span class="pre">dosfstools</span> <span class="pre">parted</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">rc-update</span> <span class="pre">add</span> <span class="pre">syslog-ng</span> <span class="pre">default</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">rc-update</span> <span class="pre">add</span> <span class="pre">cronie</span> <span class="pre">default</span></code></li>
</ul>
</div>
<div class="section" id="bootloader-non-efi-booting">
<h3><a class="toc-backref" href="#id10">bootloader (non-EFI booting)</a><a class="headerlink" href="#bootloader-non-efi-booting" title="Permalink to this headline">¶</a></h3>
<p>the <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation#Default:_GRUB2" target="_blank">default grub</a>
from the handbook</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">-av</span> <span class="pre">sys-boot/grub:2</span></code></li>
<li>be sure that <code class="docutils literal notranslate"><span class="pre">GRUB_PLATFORMS=&quot;efi-64&quot;</span></code> shows up in the output before
emerging. If not, then enable with <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">'GRUB_PLATFORMS=&quot;efi-64&quot;'</span> <span class="pre">&gt;&gt;</span> <span class="pre">/etc/portage/make.conf</span></code></li>
<li>mount the EFI system partion (has “esp” flag in <code class="docutils literal notranslate"><span class="pre">parted</span> <span class="pre">-l</span> <span class="pre">/dev/sda</span></code> output)</li>
<li><code class="docutils literal notranslate"><span class="pre">grub-install</span> <span class="pre">--target=x86_64-efi</span> <span class="pre">--efi-directory=/boot</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">grub-mkconfig</span> <span class="pre">-o</span> <span class="pre">/boot/grub/grub.cfg</span></code></li>
</ul>
</div>
<div class="section" id="final-configuration">
<h3><a class="toc-backref" href="#id11">final configuration</a><a class="headerlink" href="#final-configuration" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation#Adding_a_user_for_daily_use" target="_blank">add a user</a></p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">useradd</span> <span class="pre">-m</span> <span class="pre">-G</span> <span class="pre">users,wheel,audio,video</span> <span class="pre">-s</span> <span class="pre">/bin/zsh</span> <span class="pre">larry</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">passwd</span> <span class="pre">larry</span></code></li>
</ul>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Keyboard_layout_switching" target="_blank">set up the console keymap</a></p>
<ul class="simple">
<li>use <code class="docutils literal notranslate"><span class="pre">showkey</span></code> to get the keycode numbers of the key(s) of interest</li>
<li>edit/copy whatever keymap in <code class="docutils literal notranslate"><span class="pre">/usr/share/keymaps[/i386/qwerty]</span></code></li>
<li><dl class="first docutils">
<dt>OpenRC:</dt><dd><ul>
<li>make sure that <code class="docutils literal notranslate"><span class="pre">/etc/conf.d/keymaps</span></code> points at the file with the desired map</li>
<li><code class="docutils literal notranslate"><span class="pre">/etc/init.d/keymaps</span></code> restart</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>systemd:</dt><dd><ul>
<li>edit <code class="docutils literal notranslate"><span class="pre">/etc/vconsole.conf</span></code> to point at the map</li>
<li>FIXME presumably restart some service</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>set the console resolution</p>
<ul class="simple">
<li>enter the grub shell and use <code class="docutils literal notranslate"><span class="pre">videoinfo</span></code> to get the supported modes</li>
<li>set e.g. <code class="docutils literal notranslate"><span class="pre">GRUB_GFXMODE=1366x768</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code> and reboot</li>
</ul>
</div>
</div>
<div class="section" id="early-configuration">
<h2><a class="toc-backref" href="#id12">Early configuration</a><a class="headerlink" href="#early-configuration" title="Permalink to this headline">¶</a></h2>
<p>useful packages</p>
<ul class="simple">
<li>gentoolkit portage-utils esearch bash-completion zsh-completions gentoo-bashcomp gentoo-zsh-completions mlocate</li>
</ul>
<p>if using zsh for root, put at least this into <code class="docutils literal notranslate"><span class="pre">~/.zshrc</span></code></p>
<blockquote>
<div>autoload -U compinit promptinit
compinit
promptinit; prompt gentoo</div></blockquote>
</div>
<div class="section" id="more-installation-security">
<h2><a class="toc-backref" href="#id13">More installation security</a><a class="headerlink" href="#more-installation-security" title="Permalink to this headline">¶</a></h2>
<p>It is good to verify all of the downloads (stage3 snapshot, portage tree
snapshot, and each package source download) to make sure that they haven’t been
tampered with (as far as the signing author is concerned).</p>
<ul class="simple">
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Stage#Verifying_and_validating" target="_blank">https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Stage#Verifying_and_validating</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:Parts/Working/Features#Validated_Gentoo_repository_snapshots" target="_blank">https://wiki.gentoo.org/wiki/Handbook:Parts/Working/Features#Validated_Gentoo_repository_snapshots</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Installing_the_Gentoo_Stage_3_Files" target="_blank">https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Installing_the_Gentoo_Stage_3_Files</a></li>
<li><a class="reference external" href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Building_the_Gentoo_Base_System_Minus_Kernel" target="_blank">https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Building_the_Gentoo_Base_System_Minus_Kernel</a></li>
</ul>
</div>
<div class="section" id="dual-booting-e-g-ubuntu">
<h2><a class="toc-backref" href="#id14">Dual Booting (e.g. Ubuntu)</a><a class="headerlink" href="#dual-booting-e-g-ubuntu" title="Permalink to this headline">¶</a></h2>
<p>(coming soon)</p>
<p>for starters, see the tip box in the <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation#Configure" target="_blank">grub configure</a>
section. (grub-mkconfig)</p>
<p>consider <code class="docutils literal notranslate"><span class="pre">sys-boot/os-prober</span></code> for Detect other operating systems</p>
<div class="section" id="ubuntu-20-04-after-gentoo">
<h3><a class="toc-backref" href="#id15">Ubuntu 20.04 after Gentoo</a><a class="headerlink" href="#ubuntu-20-04-after-gentoo" title="Permalink to this headline">¶</a></h3>
<p>This was an odd experiment. I had super vanilla (no lvm, normal grub, etc)
gentoo installed on <code class="docutils literal notranslate"><span class="pre">/dev/sda3</span></code>, with its <code class="docutils literal notranslate"><span class="pre">/boot</span></code> and ESP on <code class="docutils literal notranslate"><span class="pre">/dev/sda1</span></code>.
I then <code class="docutils literal notranslate"><span class="pre">dd</span> <span class="pre">if=/dev/sda3</span> <span class="pre">of=/dev/sda4</span></code>, and copied the <code class="docutils literal notranslate"><span class="pre">/boot</span></code> from
<code class="docutils literal notranslate"><span class="pre">/dev/sda1</span></code> to the <code class="docutils literal notranslate"><span class="pre">/boot</span></code> directory on <code class="docutils literal notranslate"><span class="pre">/dev/sda4</span></code>. This gave me two
identical gentoos, even with the same UUIDs in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> (since they come
from the filesystem).</p>
<p>The ubuntu installer asked me about installing beside multiple other oses, but
the option it gave me for automatic drive formatting didn’t look reasonable. So
I did the advanced setup myself. Here, I selected <code class="docutils literal notranslate"><span class="pre">/dev/sda5</span></code> as a physical
lvm partition for encryption and set a passphrase. Then I place root on it as
ext4. The installer complained that since it was encrypted, it needed a separate
<code class="docutils literal notranslate"><span class="pre">/boot</span></code>, so I placed this on <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> as ext4.</p>
<p>This resulted in ubuntu placing a new EFI entry first in the bios, and
presenting a grub menu with ubuntu, and gentoo on <code class="docutils literal notranslate"><span class="pre">/dev/sda4</span></code>. Both of these
boot fine. I can boot gentoo on <code class="docutils literal notranslate"><span class="pre">/dev/sda3</span></code> by entering the bios boot
selection and picking the “gentoo” option, which is now second in the list.</p>
<p>Suspicions</p>
<ul>
<li><p class="first">Based on another experiment, the ubuntu installer insisted on having a
separate EFI system partition from <code class="docutils literal notranslate"><span class="pre">/boot</span></code> (even though this isn’t required
when you’re not PC/BIOS booting GPT), so even though I gave it a separate
<code class="docutils literal notranslate"><span class="pre">/boot</span></code> parition, it used one of the other gentoo <code class="docutils literal notranslate"><span class="pre">/boot</span></code> partitions that
was marked for both boot and ESP - it wrote to the <code class="docutils literal notranslate"><span class="pre">/boot/EFI</span></code> directory.</p>
</li>
<li><p class="first">Ubuntu’s bootloader is booting sda4 gentoo because it can find the <code class="docutils literal notranslate"><span class="pre">/boot</span></code>
easily, and it needs at least the kernel and maybe the efi info from it.</p>
</li>
<li><p class="first">Ubuntu can boot <code class="docutils literal notranslate"><span class="pre">/dev/sda4</span></code> gentoo because Ubuntu’s bootloader is ignoring
the grub config in <code class="docutils literal notranslate"><span class="pre">/boot</span></code> of <code class="docutils literal notranslate"><span class="pre">/dev/sda4</span></code>.</p>
</li>
<li><p class="first">I’m not completely sure how other parts of the system are getting confused by
the identical UUIDs, but presumably the device argument to the kernel at boot
time is enough to settle this.</p>
</li>
<li><p class="first">There seem to be two ways to easily dual-boot these two (ubuntu/gentoo):</p>
<blockquote>
<div><ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">os-prober</span></code> utility from within ubuntu finds both gentoos. However, the
<code class="docutils literal notranslate"><span class="pre">30_os-prober</span></code> script is only generating an entry for <code class="docutils literal notranslate"><span class="pre">/dev/sda4</span></code> gentoo
in <code class="docutils literal notranslate"><span class="pre">/boot/grub/grub.cfg</span></code> in ubuntu. Maybe I can also configure grub the grub
config in ubuntu to include the <code class="docutils literal notranslate"><span class="pre">/dev/sda1,3</span></code> gentoo. The simplest way seems
to be to use the <code class="docutils literal notranslate"><span class="pre">/etc/grub.d/40_custom</span></code> entry and then rerun something like
<code class="docutils literal notranslate"><span class="pre">grub-mkconfig</span></code> - just copy the menu entries from the original gentoo’s
<code class="docutils literal notranslate"><span class="pre">/boot/grub/grub.cfg</span></code>.</li>
<li>One could just go ahead and let any OS install itself onto unused
parition(s), and then use the bios EFI selector to order and pick. This
also implies that partioning needs to include at least a separate boot/esp
partition for each OS (especially if it is encrypted).</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="encrypted-drive">
<h2><a class="toc-backref" href="#id16">Encrypted drive</a><a class="headerlink" href="#encrypted-drive" title="Permalink to this headline">¶</a></h2>
<p>This is done with <code class="docutils literal notranslate"><span class="pre">dm-crypt</span></code> and LUKS. Setting up the drives is
straightforward. But then an initramfs is also needed so that the kernel can
decrypt the root drive when booting.</p>
<p>(coming soon)</p>
</div>
<div class="section" id="rescue-partitions-and-media">
<h2><a class="toc-backref" href="#id17">Rescue partitions and media</a><a class="headerlink" href="#rescue-partitions-and-media" title="Permalink to this headline">¶</a></h2>
<p>consider <code class="docutils literal notranslate"><span class="pre">dev-libs/libisoburn</span></code> for Create rescue media (grub-mkrescue)</p>
<div class="section" id="manual-backups">
<h3><a class="toc-backref" href="#id18">manual backups</a><a class="headerlink" href="#manual-backups" title="Permalink to this headline">¶</a></h3>
<p>One could use the following procedure:</p>
<ol class="arabic">
<li><p class="first">tar up the host sysem (from live media / not when it is booted)</p>
</li>
<li><p class="first">untar from live media onto a new partition as if it were a mega stage3</p>
<blockquote>
<div><ul class="simple">
<li>remember to use <code class="docutils literal notranslate"><span class="pre">tar</span> <span class="pre">xvpjf</span> <span class="pre">backup.tar.bz2</span> <span class="pre">--xattrs-include='*.*'</span> <span class="pre">--numeric-owner</span></code></li>
</ul>
</div></blockquote>
</li>
</ol>
<p>3. change uuids as needed in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>, etc.
3. change options (like GRUB_GFXMODE) in <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code>
4. reconfigure/reinstall the bootloader with e.g.</p>
<blockquote>
<div><ul class="simple">
<li>to update the UUIDs etc. in the grub config: <code class="docutils literal notranslate"><span class="pre">grub-mkconfig</span> <span class="pre">-o</span> <span class="pre">/boot/grub/grub.cfg</span></code></li>
<li>to update the UEFI entry for this OS: <code class="docutils literal notranslate"><span class="pre">grub-install</span> <span class="pre">--target=x86_64-efi</span> <span class="pre">--efi-directory=/boot</span></code></li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="5">
<li>on the thinkpad, there is no option in the bios to manually add UEFI boot
entries, but the <code class="docutils literal notranslate"><span class="pre">grub-install</span></code> seems to have populated it (and put it
first). On the dell, the UEFI entry was not present even after the
<code class="docutils literal notranslate"><span class="pre">grub-install</span></code>, so I added it manually (it even let me browse to the efi
file on the two detected ESPs) in the bios setup and it booted just fine.</li>
<li>update the hostname in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> and <code class="docutils literal notranslate"><span class="pre">/etc/conf.d/hostname</span></code></li>
</ol>
</div>
</div>
<div class="section" id="uefi-boot-no-bootloader">
<h2><a class="toc-backref" href="#id19">UEFI boot (no bootloader)</a><a class="headerlink" href="#uefi-boot-no-bootloader" title="Permalink to this headline">¶</a></h2>
<p>In fact, even though <code class="docutils literal notranslate"><span class="pre">grub</span></code> is typically used to boot EFI systems, it can be
done straight from the bios as described in Sakaki’s guide.</p>
<p>Essentially, there needs to be an EFI type partition with a FAT32 filesystem.
Most firmwares can be configured with the path to the image, but the default is
<code class="docutils literal notranslate"><span class="pre">\EFI\BOOT\BOOTX64</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">efibootmgr</span></code> utility can be used to manage UEFI boot entries. It is not a
bootloader, but it rather interacts with the EFI firmware of the system itself.
The Gentoo Handbook has a short section on setting this up at <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Bootloader#Alternative_2:_efibootmgr" target="_blank">Alternative 2:
efibootmgr</a>.</p>
<p>For more information, check out:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.happyassassin.net/posts/2014/01/25/uefi-boot-how-does-that-actually-work-then/" target="_blank">UEFI boot: how does that actually work, then? | AdamW</a></li>
<li><a class="reference external" href="http://www.rodsbooks.com/efi-bootloaders/" target="_blank">Managing EFI Boot Loaders for Linux by Rod Smith</a></li>
</ul>
</div>
<div class="section" id="systemd-gnome-3-28">
<h2><a class="toc-backref" href="#id20">Systemd / Gnome 3.28+</a><a class="headerlink" href="#systemd-gnome-3-28" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/systemd" target="_blank">arch’s wiki page</a> is quite
good.</li>
</ul>
<p>This can be done as a conversion after the installation - really at any time.</p>
<p>(coming soon)</p>
</div>
<div class="section" id="notes-on-using-portage">
<h2><a class="toc-backref" href="#id21">Notes on Using Portage</a><a class="headerlink" href="#notes-on-using-portage" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Portage" target="_blank">https://wiki.gentoo.org/wiki/Portage</a></p>
<p>useful tools:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">app-portage/gentoolkit</span></code> is useful
(equery, <a class="reference external" href="https://wiki.gentoo.org/wiki/Gentoolkit#euse" target="_blank">euse</a>,
revdep-rebuild, among others).</li>
<li><code class="docutils literal notranslate"><span class="pre">dispatch-conf</span></code> (included)</li>
<li><code class="docutils literal notranslate"><span class="pre">app-portage/esearch</span></code></li>
<li>portage-utils</li>
<li>bash-completion</li>
<li>zsh-completions</li>
<li>gentoo-bashcomp</li>
<li>gentoo-zsh-completions</li>
<li>mlocate</li>
</ul>
<p>The world file at <code class="docutils literal notranslate"><span class="pre">/var/lib/portage/world</span></code> shows all packages installed by the
user</p>
<p>The default gentoo package tree lives at <code class="docutils literal notranslate"><span class="pre">/var/db/repos/gentoo</span></code>. Besides all
of the ebuilds, the profiles live here as well (including make.defaults,
use.desc, use.local.desc, etc.).</p>
<div class="section" id="saving-space">
<h3><a class="toc-backref" href="#id22">saving space</a><a class="headerlink" href="#saving-space" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">firmware</p>
<blockquote>
<div><p>edit <code class="docutils literal notranslate"><span class="pre">/etc/portage/savedconfig/sys-kernel/linux-firmware-*</span></code> and remove the
blobs that aren’t needed. Leaving just <code class="docutils literal notranslate"><span class="pre">intel-*</span></code> and <code class="docutils literal notranslate"><span class="pre">iwlwifi-*</span></code> resulted in
going from 521M to 144M.</p>
</div></blockquote>
</li>
<li><p class="first">distfiles</p>
<blockquote>
<div><p>clear out <code class="docutils literal notranslate"><span class="pre">DISTDIR</span></code> where portage keeps the downloaded source tarballs. By
default, this is at <code class="docutils literal notranslate"><span class="pre">/var/cache/distfiles</span></code>. There is also an <code class="docutils literal notranslate"><span class="pre">eclean</span></code>
utility as part of gentoolkit, but I have no experience with it yet.</p>
</div></blockquote>
</li>
<li><p class="first">linux kernel sources</p>
<blockquote>
<div><p>clear out the old sources in <code class="docutils literal notranslate"><span class="pre">/usr/src/linux-*</span></code>. Watch out; portage will
try to do this for you automatically when it merges a new source tree.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="make-conf">
<h3><a class="toc-backref" href="#id23">make.conf</a><a class="headerlink" href="#make-conf" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki//etc/portage/make.conf" target="_blank">https://wiki.gentoo.org/wiki//etc/portage/make.conf</a></p>
</div>
<div class="section" id="use-flags">
<h3><a class="toc-backref" href="#id24">USE flags</a><a class="headerlink" href="#use-flags" title="Permalink to this headline">¶</a></h3>
<p>sources of truth for the system:</p>
<ul class="simple">
<li>descriptions of all global[/local] USE flags known to the system are at
<code class="docutils literal notranslate"><span class="pre">/var/db/repos/gentoo/profiles/use[.local].desk</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">-pv</span> <span class="pre">packagename</span></code> shows what USE flagss were/will be used to build
packagename</li>
</ul>
<p>utilities for working with USE flags (shortcuts)</p>
<ul class="simple">
<li>FIXME: quse, euse, equery portageq</li>
</ul>
<p><a class="reference external" href="https://www.gentoo.org/support/use-flags/" target="_blank">the complete USE flag index (global and local)</a></p>
<p>and some <a class="reference external" href="https://wiki.gentoo.org/wiki/USE_flag" target="_blank">hints and utilities</a> about
working with USE flags.</p>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Working/USE#Satisfying_REQUIRED_USE_conditions" target="_blank">Here is an explanation</a>
of some <code class="docutils literal notranslate"><span class="pre">REQUIRED_USE</span></code> expressions.</p>
</div>
<div class="section" id="video-cards">
<h3><a class="toc-backref" href="#id25">VIDEO_CARDS</a><a class="headerlink" href="#video-cards" title="Permalink to this headline">¶</a></h3>
<p>see <a class="reference external" href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager#Hardware_support" target="_blank">this DRM driver list</a> for
which cards are supported by each driver.</p>
<p>and <a class="reference external" href="https://wiki.gentoo.org/wiki/Intel#Feature_support" target="_blank">this feature list</a>
for which driver to use with which intel chipset generation. There is also a lot
of useful information on that same page about configuring kernel options,
drivers and USE flags for X, etc.</p>
</div>
<div class="section" id="tips-and-tricks">
<h3><a class="toc-backref" href="#id26">tips and tricks</a><a class="headerlink" href="#tips-and-tricks" title="Permalink to this headline">¶</a></h3>
<p>If you want to enable Portage completions and Gentoo prompt,
<code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">app-shells/gentoo-zsh-completions</span></code> and add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">autoload</span> <span class="o">-</span><span class="n">U</span> <span class="n">compinit</span> <span class="n">promptinit</span>
<span class="n">compinit</span>
<span class="n">promptinit</span><span class="p">;</span> <span class="n">prompt</span> <span class="n">gentoo</span>
</pre></div>
</div>
<p>to your <code class="docutils literal notranslate"><span class="pre">~/.zshrc</span></code>
Also, if you want to enable cache for the completions, add
<code class="docutils literal notranslate"><span class="pre">zstyle</span> <span class="pre">':completion::complete:*'</span> <span class="pre">use-cache</span> <span class="pre">1</span></code>
to your <code class="docutils literal notranslate"><span class="pre">~/.zshrc</span></code></p>
</div>
</div>
<div class="section" id="unsorted">
<h2><a class="toc-backref" href="#id27">Unsorted</a><a class="headerlink" href="#unsorted" title="Permalink to this headline">¶</a></h2>
<p>if <code class="docutils literal notranslate"><span class="pre">/bin/ping</span></code> gives an “Operation not permitted” when run by an unpriviledged
user (but works as root), then <code class="docutils literal notranslate"><span class="pre">setcap</span> <span class="pre">cap_net_raw=ep</span> <span class="pre">/bin/ping</span></code>.</p>
<div class="section" id="tmux-split-characters">
<h3><a class="toc-backref" href="#id28">tmux split characters</a><a class="headerlink" href="#tmux-split-characters" title="Permalink to this headline">¶</a></h3>
<p>If tmux shows ‘x’/’q’ for vertical/horizontal bars when splitting panes, then
<a class="reference external" href="https://stackoverflow.com/questions/8483798/tmux-borders-displayed-as-x-q-instead-of-lines" target="_blank">there is a mismatch</a>
between the terminal and terminfo being used by tmux.</p>
<p>The core cause of this is utf8 being set incorrectly. One thing to test is to
force tmux to draw unicode characters by starting with <code class="docutils literal notranslate"><span class="pre">tmux</span> <span class="pre">-u</span></code>.</p>
<p>The real way to set this is to set to a utf8 locale. <code class="docutils literal notranslate"><span class="pre">eselect</span> <span class="pre">locale</span> <span class="pre">list/set</span></code>
and a new login shell should be sufficient. The gentoo wiki articles are
thorough, see <a class="reference external" href="https://wiki.gentoo.org/wiki/UTF-8" target="_blank">utf8 on gentoo wiki</a> and
<a class="reference external" href="https://wiki.gentoo.org/wiki/Localization/Guide" target="_blank">localization/guide</a>.</p>
</div>
<div class="section" id="lcd-brightness">
<h3><a class="toc-backref" href="#id29">lcd brightness</a><a class="headerlink" href="#lcd-brightness" title="Permalink to this headline">¶</a></h3>
<p>At least in the console, we can do this manually. First, test if the kernel has
the necessary support:</p>
<blockquote>
<div>grep BACKLIGHT /boot/config</div></blockquote>
<p>and then trying writing values into <code class="docutils literal notranslate"><span class="pre">/sys/class/backlight/[something]/brightness</span></code>.</p>
</div>
</div>
<div class="section" id="other-gentoo">
<h2><a class="toc-backref" href="#id30">Other Gentoo</a><a class="headerlink" href="#other-gentoo" title="Permalink to this headline">¶</a></h2>
<p>check out <a class="reference external" href="https://wiki.gentoo.org/wiki/Project:Prefix" target="_blank">gentoo prefix</a> to use
gentoo in other OSes.</p>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="index.html" title="Previous document">Operating Systems</a>
        </li>
        <li>
          <a href="ubuntu_20.04.html" title="Next document">Ubuntu 20.04</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2021, M. Graham Lopez.
      
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-140879797-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>